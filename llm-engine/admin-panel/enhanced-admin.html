<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Literacy Hub - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            background-color: #2c3e50;
            color: white;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.7);
            margin: 0.25rem 0;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .main-content {
            margin-left: 250px;
        }
        .stat-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .chart-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .module-card {
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        .module-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .status-badge {
            font-size: 0.75rem;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Sidebar -->
    <div class="sidebar d-flex flex-column p-3">
        <h4 class="text-white mb-4">
            <i class="bi bi-speedometer2 me-2"></i>Digital Literacy Hub
        </h4>
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="#" class="nav-link active" data-view="dashboard">
                    <i class="bi bi-house-door me-2"></i>Dashboard
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-view="modules">
                    <i class="bi bi-journals me-2"></i>Knowledge Modules
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-view="users">
                    <i class="bi bi-people me-2"></i>User Management
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-view="analytics">
                    <i class="bi bi-bar-chart me-2"></i>Analytics
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-view="settings">
                    <i class="bi bi-gear me-2"></i>Settings
                </a>
            </li>
        </ul>
        <hr class="text-light">
        <div class="dropdown">
            <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle me-2"></i>
                <strong>Admin User</strong>
            </a>
            <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
                <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Profile</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Sign out</a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard View -->
        <div id="dashboard-view" class="container-fluid p-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Dashboard</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="refreshDashboard()">
                        <i class="bi bi-arrow-repeat me-1"></i>Refresh
                    </button>
                    <button type="button" class="btn btn-sm btn-primary" onclick="triggerUpdate()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Update Knowledge Base
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4" id="stats-cards">
                <div class="col-md-3 mb-3">
                    <div class="card stat-card border-0 bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title">Total Modules</h5>
                                    <h2 class="mb-0" id="total-modules">0</h2>
                                </div>
                                <i class="bi bi-journal-text" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card border-0 bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title">Total Steps</h5>
                                    <h2 class="mb-0" id="total-steps">0</h2>
                                </div>
                                <i class="bi bi-list-check" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card border-0 bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title">Categories</h5>
                                    <h2 class="mb-0" id="total-categories">0</h2>
                                </div>
                                <i class="bi bi-tags" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card border-0 bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5 class="card-title">Sectors</h5>
                                    <h2 class="mb-0" id="total-sectors">0</h2>
                                </div>
                                <i class="bi bi-building" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5 class="mb-3">Modules by Category</h5>
                        <canvas id="category-chart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5 class="mb-3">Modules by Sector</h5>
                        <canvas id="sector-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Modules -->
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Recent Modules</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadModulesView()">View All</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Topic</th>
                                <th>Category</th>
                                <th>Sector</th>
                                <th>Language</th>
                                <th>Last Updated</th>
                            </tr>
                        </thead>
                        <tbody id="recent-modules">
                            <tr>
                                <td colspan="5" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modules View -->
        <div id="modules-view" class="container-fluid p-4" style="display: none;">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Knowledge Modules</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addModuleModal">
                        <i class="bi bi-plus-lg me-1"></i>Add Module
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshModules()">
                        <i class="bi bi-arrow-repeat me-1"></i>Refresh
                    </button>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-3">
                    <select class="form-select" id="category-filter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="sector-filter">
                        <option value="">All Sectors</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="language-filter">
                        <option value="">All Languages</option>
                        <option value="en">English</option>
                        <option value="am">Amharic</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="search-modules" placeholder="Search modules...">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchModules()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="row" id="modules-grid">
                <div class="col-12 text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users View -->
        <div id="users-view" class="container-fluid p-4" style="display: none;">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">User Management</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-download me-1"></i>Export
                    </button>
                </div>
            </div>

            <div class="chart-container">
                <h5 class="mb-3">User Statistics</h5>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Total Users</h5>
                                <h2 class="text-primary">1,248</h2>
                                <p class="text-muted">+12% from last month</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Active Users</h5>
                                <h2 class="text-success">856</h2>
                                <p class="text-muted">68% of total users</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">New Users</h5>
                                <h2 class="text-warning">124</h2>
                                <p class="text-muted">This month</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Avg. Session</h5>
                                <h2 class="text-info">18m 32s</h2>
                                <p class="text-muted">+2m from last month</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h5 class="mb-3">Recent User Activity</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Last Active</th>
                                <th>Modules Completed</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Abebe Kebede</td>
                                <td>abebe@example.com</td>
                                <td>2 minutes ago</td>
                                <td>3</td>
                                <td><span class="badge bg-success">Online</span></td>
                            </tr>
                            <tr>
                                <td>Mahlet Tesfaye</td>
                                <td>mahlet@example.com</td>
                                <td>1 hour ago</td>
                                <td>7</td>
                                <td><span class="badge bg-secondary">Offline</span></td>
                            </tr>
                            <tr>
                                <td>Kebede Worku</td>
                                <td>kebede@example.com</td>
                                <td>3 hours ago</td>
                                <td>12</td>
                                <td><span class="badge bg-secondary">Offline</span></td>
                            </tr>
                            <tr>
                                <td>Fatuma Ali</td>
                                <td>fatuma@example.com</td>
                                <td>1 day ago</td>
                                <td>5</td>
                                <td><span class="badge bg-secondary">Offline</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analytics View -->
        <div id="analytics-view" class="container-fluid p-4" style="display: none;">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Analytics</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <select class="form-select form-select-sm me-2">
                        <option>Last 7 days</option>
                        <option selected>Last 30 days</option>
                        <option>Last 90 days</option>
                    </select>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="chart-container">
                        <h5 class="mb-3">Module Usage Over Time</h5>
                        <canvas id="usage-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5 class="mb-3">Top Modules by Views</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Module</th>
                                        <th>Views</th>
                                        <th>Completion Rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>VAT Filing</td>
                                        <td>1,248</td>
                                        <td>78%</td>
                                    </tr>
                                    <tr>
                                        <td>Import Declaration</td>
                                        <td>987</td>
                                        <td>65%</td>
                                    </tr>
                                    <tr>
                                        <td>Income Tax Filing</td>
                                        <td>856</td>
                                        <td>72%</td>
                                    </tr>
                                    <tr>
                                        <td>Export Declaration</td>
                                        <td>723</td>
                                        <td>58%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5 class="mb-3">User Engagement by Sector</h5>
                        <canvas id="engagement-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settings-view" class="container-fluid p-4" style="display: none;">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Settings</h1>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5 class="mb-3">System Configuration</h5>
                        <form>
                            <div class="mb-3">
                                <label class="form-label">API Endpoint</label>
                                <input type="text" class="form-control" value="http://localhost:3001" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Update Schedule</label>
                                <select class="form-select">
                                    <option>Daily</option>
                                    <option selected>Weekly</option>
                                    <option>Monthly</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Language Support</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="lang-en" checked>
                                        <label class="form-check-label" for="lang-en">English</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="lang-am" checked>
                                        <label class="form-check-label" for="lang-am">Amharic</label>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5 class="mb-3">System Status</h5>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>API Server</span>
                                <span class="badge bg-success">Running</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Database</span>
                                <span class="badge bg-success">Connected</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Last Update</span>
                                <span>2 hours ago</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Knowledge Base</span>
                                <span class="badge bg-success">Up to date</span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary w-100" onclick="triggerUpdate()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Force Update
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Module Modal -->
    <div class="modal fade" id="addModuleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Knowledge Module</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="module-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Module</label>
                                <select class="form-select" id="module" required>
                                    <option value="E-Tax System">E-Tax System</option>
                                    <option value="Customs & e-SW">Customs & e-SW</option>
                                    <option value="SME Digital Skills">SME Digital Skills</option>
                                    <option value="Regulatory & Compliance">Regulatory & Compliance</option>
                                    <option value="Training & Tutorials">Training & Tutorials</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="category" required>
                                    <option value="Tax">Tax</option>
                                    <option value="Customs">Customs</option>
                                    <option value="SME Services">SME Services</option>
                                    <option value="Regulations">Regulations</option>
                                    <option value="Training">Training</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Topic</label>
                                <input type="text" class="form-control" id="topic" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Sector</label>
                                <select class="form-select" id="sector" required>
                                    <option value="Manufacturing">Manufacturing</option>
                                    <option value="Textile">Textile</option>
                                    <option value="Garments">Garments</option>
                                    <option value="Agro">Agro</option>
                                    <option value="Import/Export">Import/Export</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Steps (one per line)</label>
                            <textarea class="form-control" id="steps" rows="5" placeholder="Enter steps, one per line"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Requirements (one per line)</label>
                                <textarea class="form-control" id="requirements" rows="3" placeholder="Enter requirements, one per line"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Validation (one per line)</label>
                                <textarea class="form-control" id="validation" rows="3" placeholder="Enter validation steps, one per line"></textarea>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Source URL</label>
                            <input type="url" class="form-control" id="source" placeholder="https://example.gov.et">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addNewModule()">Add Module</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Check if user is authenticated
        if (localStorage.getItem('adminLoggedIn') !== 'true') {
            // Redirect to login page if not authenticated
            window.location.href = 'login.html';
        }

        // Logout function
        function logout() {
            // Remove authentication status
            localStorage.removeItem('adminLoggedIn');
            // Redirect to login page
            window.location.href = 'login.html';
        }

        // Global variables
        let currentView = 'dashboard';
        let chartInstances = {};
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set up navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const view = this.getAttribute('data-view');
                    switchView(view);
                });
            });
            
            // Load initial data
            loadDashboardData();
            loadFilters();
        });
        
        // Switch between views
        function switchView(view) {
            // Hide all views
            document.querySelectorAll('[id$="-view"]').forEach(el => {
                el.style.display = 'none';
            });
            
            // Show selected view
            document.getElementById(`${view}-view`).style.display = 'block';
            
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            
            // Load data for the view if needed
            switch(view) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'modules':
                    loadModulesData();
                    break;
                case 'analytics':
                    loadAnalyticsData();
                    break;
            }
            
            currentView = view;
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            try {
                showLoading('#stats-cards');
                
                // Fetch stats
                const response = await fetch('http://localhost:3001/admin/stats');
                const stats = await response.json();
                
                // Update stats cards
                document.getElementById('total-modules').textContent = stats.totalModules;
                document.getElementById('total-steps').textContent = stats.totalSteps;
                document.getElementById('total-categories').textContent = Object.keys(stats.modulesByCategory || {}).length;
                document.getElementById('total-sectors').textContent = Object.keys(stats.modulesBySector || {}).length;
                
                // Update charts
                updateCategoryChart(stats.modulesByCategory || {});
                updateSectorChart(stats.modulesBySector || {});
                
                // Load recent modules
                loadRecentModules();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Error loading dashboard data', 'danger');
            }
        }
        
        // Load recent modules
        async function loadRecentModules() {
            try {
                const response = await fetch('http://localhost:3001/admin/modules');
                const modules = await response.json();
                
                const tbody = document.getElementById('recent-modules');
                tbody.innerHTML = '';
                
                // Sort by last updated and take first 5
                const recentModules = [...modules]
                    .sort((a, b) => new Date(b.metadata?.lastUpdated || b.lastUpdated) - new Date(a.metadata?.lastUpdated || a.lastUpdated))
                    .slice(0, 5);
                
                if (recentModules.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No modules found</td></tr>';
                    return;
                }
                
                recentModules.forEach(module => {
                    const row = document.createElement('tr');
                    const lastUpdated = new Date(module.metadata?.lastUpdated || module.lastUpdated);
                    row.innerHTML = `
                        <td>${module.topic}</td>
                        <td>${module.category}</td>
                        <td>${module.sector}</td>
                        <td><span class="badge bg-${module.language === 'am' ? 'warning' : 'primary'}">${module.language}</span></td>
                        <td>${lastUpdated.toLocaleDateString()}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading recent modules:', error);
                document.getElementById('recent-modules').innerHTML = '<tr><td colspan="5" class="text-center">Error loading modules</td></tr>';
            }
        }
        
        // Load modules data
        async function loadModulesData() {
            try {
                showLoading('#modules-grid');
                
                const response = await fetch('http://localhost:3001/admin/modules');
                const modules = await response.json();
                
                renderModulesGrid(modules);
            } catch (error) {
                console.error('Error loading modules:', error);
                document.getElementById('modules-grid').innerHTML = '<div class="col-12 text-center text-danger">Error loading modules</div>';
            }
        }
        
        // Render modules grid
        function renderModulesGrid(modules) {
            const container = document.getElementById('modules-grid');
            
            if (modules.length === 0) {
                container.innerHTML = '<div class="col-12 text-center"><p>No modules found</p></div>';
                return;
            }
            
            container.innerHTML = '';
            
            modules.forEach(module => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-4';
                col.innerHTML = `
                    <div class="card module-card h-100">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${module.topic}</h5>
                            <p class="card-text flex-grow-1">
                                <small class="text-muted">
                                    <i class="bi bi-tag me-1"></i> ${module.category}<br>
                                    <i class="bi bi-building me-1"></i> ${module.sector}
                                </small>
                            </p>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="status-badge badge bg-${module.language === 'am' ? 'warning' : 'primary'}">
                                    ${module.language === 'am' ? 'Amharic' : 'English'}
                                </span>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewModule('${module.id}')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteModule('${module.id}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }
        
        // Load filters
        async function loadFilters() {
            try {
                const response = await fetch('http://localhost:3001/admin/modules');
                const modules = await response.json();
                
                // Get unique categories and sectors
                const categories = [...new Set(modules.map(m => m.category))];
                const sectors = [...new Set(modules.map(m => m.sector))];
                
                // Populate category filter
                const categoryFilter = document.getElementById('category-filter');
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
                
                // Populate sector filter
                const sectorFilter = document.getElementById('sector-filter');
                sectors.forEach(sector => {
                    const option = document.createElement('option');
                    option.value = sector;
                    option.textContent = sector;
                    sectorFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading filters:', error);
            }
        }
        
        // Refresh dashboard
        function refreshDashboard() {
            loadDashboardData();
            showToast('Dashboard refreshed', 'success');
        }
        
        // Refresh modules
        function refreshModules() {
            loadModulesData();
            showToast('Modules refreshed', 'success');
        }
        
        // Trigger knowledge base update
        async function triggerUpdate() {
            try {
                showToast('Starting knowledge base update...', 'info');
                
                const response = await fetch('http://localhost:3001/admin/update', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast(result.message, 'success');
                    // Refresh data after update
                    if (currentView === 'dashboard') {
                        loadDashboardData();
                    } else if (currentView === 'modules') {
                        loadModulesData();
                    }
                } else {
                    showToast(`Update failed: ${result.error}`, 'danger');
                }
            } catch (error) {
                console.error('Error triggering update:', error);
                showToast('Error triggering update', 'danger');
            }
        }
        
        // View module details
        async function viewModule(id) {
            try {
                const response = await fetch(`http://localhost:3001/modules/${id}`);
                const module = await response.json();
                
                if (module) {
                    alert(`Module Details:

Topic: ${module.topic}
Category: ${module.category}
Sector: ${module.sector}

Steps: ${module.steps.length}
Requirements: ${module.requirements.length}
Validation: ${module.validation.length}`);
                }
            } catch (error) {
                console.error('Error viewing module:', error);
                showToast('Error viewing module', 'danger');
            }
        }
        
        // Delete module
        async function deleteModule(id) {
            if (!confirm('Are you sure you want to delete this module?')) {
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:3001/admin/modules/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('Module deleted successfully', 'success');
                    // Refresh current view
                    if (currentView === 'modules') {
                        loadModulesData();
                    } else if (currentView === 'dashboard') {
                        loadDashboardData();
                    }
                } else {
                    const result = await response.json();
                    showToast(`Delete failed: ${result.error}`, 'danger');
                }
            } catch (error) {
                console.error('Error deleting module:', error);
                showToast('Error deleting module', 'danger');
            }
        }
        
        // Add new module
        function addNewModule() {
            // In a real implementation, this would collect form data and make an API call
            showToast('New module would be added in a real implementation', 'info');
            bootstrap.Modal.getInstance(document.getElementById('addModuleModal')).hide();
            document.getElementById('module-form').reset();
        }
        
        // Save settings
        function saveSettings() {
            showToast('Settings saved successfully', 'success');
        }
        
        // Update category chart
        function updateCategoryChart(data) {
            const ctx = document.getElementById('category-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (chartInstances.category) {
                chartInstances.category.destroy();
            }
            
            const labels = Object.keys(data);
            const values = Object.values(data);
            
            chartInstances.category = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Modules by Category',
                        data: values,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // Update sector chart
        function updateSectorChart(data) {
            const ctx = document.getElementById('sector-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (chartInstances.sector) {
                chartInstances.sector.destroy();
            }
            
            const labels = Object.keys(data);
            const values = Object.values(data);
            
            chartInstances.sector = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 205, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 205, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }
        
        // Load analytics data
        function loadAnalyticsData() {
            // Usage chart
            const usageCtx = document.getElementById('usage-chart').getContext('2d');
            if (chartInstances.usage) {
                chartInstances.usage.destroy();
            }
            
            chartInstances.usage = new Chart(usageCtx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Module Views',
                        data: [120, 190, 150, 210],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }, {
                        label: 'Completions',
                        data: [80, 140, 110, 160],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Engagement chart
            const engagementCtx = document.getElementById('engagement-chart').getContext('2d');
            if (chartInstances.engagement) {
                chartInstances.engagement.destroy();
            }
            
            chartInstances.engagement = new Chart(engagementCtx, {
                type: 'bar',
                data: {
                    labels: ['Manufacturing', 'Textile', 'Garments', 'Agro', 'Import/Export'],
                    datasets: [{
                        label: 'User Engagement (%)',
                        data: [78, 65, 72, 58, 82],
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // Show loading indicator
        function showLoading(selector) {
            const element = document.querySelector(selector);
            if (element) {
                element.innerHTML = '<div class="col-12 text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast, {
                delay: 3000
            });
            
            bsToast.show();
            
            // Remove toast after it's hidden
            toast.addEventListener('hidden.bs.toast', function() {
                toast.remove();
            });
        }
    </script>
</body>
</html>